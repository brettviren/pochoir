#!/usr/bin/env snakemake
'''
There are:
- 1->many config files generated from tutorial.jsonnet, 
- each config in a category subdir cfg/<cat>s/<item>.json
- cat in [dom,gen]

'''

import json

DOMS = ["wfar",]
GENS = ["sandh",]
CATS = {"doms":DOMS,"gens":GENS}

cfg_dir = "cfg"
store_dir = "store"

def cfgdir(cats):
    return f'{cfg_dir}/{cats}'
def cfgfile(cats, name):
    return cfgdir(cats) + f'/{name}.json'
def stofile(cats, name):
    return f'{store_dir}/{cats}/{name}.npz'

dom_cfg_p = f"{cfg_dir}/doms/{{dom}}.json"
gen_cfg_p = f"{cfg_dir}/gens/{{gen}}.json"

rule cfgs:
    input:
        "tutorial.jsonnet"
    output:
        doms = [cfgfile("doms", d) for d in DOMS],
        gens = [cfgfile("gens", d) for d in GENS]
    params:
        odirs = [cfgdir(c) for c in CATS]
    shell:
        "mkdir -p {params.odirs}; jsonnet -m cfg {input}"

dom_key_p = "doms/{dom}"
dom_origin_p = f"{store_dir}/{dom_key_p}/origin.npz"
dom_shape_p = f"{store_dir}/{dom_key_p}/shape.npz"
dom_spacing_p = f"{store_dir}/{dom_key_p}/spacing.npz"
dom_files_p = [dom_origin_p, dom_shape_p, dom_spacing_p]

def dom_cfg(w):
    return json.load(open(cfgfile("doms", w.dom)))

rule domain:
    input:
        cfgfile = dom_cfg_p
    output:
        outfiles = dom_files_p
    params:
        cfg = dom_cfg,
        key = dom_key_p
    shell: """pochoir -s {store_dir} domain \
    --shape {params.cfg[shape]} \
    --spacing {params.cfg[spacing]} {params.key}"""

iva_key_p = "iva/{gen}-{dom}"
bva_key_p = "bva/{gen}-{dom}"


rule gen:
    input:
        rules.domain.output.outfiles,
        cfgf = cfgfile("gens", "{gen}")
    params:
        iva_key = iva_key_p,
        bva_key = bva_key_p,
        dom_key = dom_key_p
    output:
        iva = f"{store_dir}/{iva_key_p}.npz",
        bva = f"{store_dir}/{bva_key_p}.npz"
    shell: """
    pochoir -s {store_dir} gen -d {params.dom_key} \
      -i {params.iva_key} -b {params.bva_key} -g {wildcards.gen} \
      {input.cfgf}
    """
    
rule all:
    input:
        iva=f'{store_dir}/iva/sandh-wfar.npz',
        bva=f'{store_dir}/bva/sandh-wfar.npz'
